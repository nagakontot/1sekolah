<!DOCTYPE html>
<html lang="en">
	<head>
		<title>three.js webgl - particles - sprites</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<style>
			body {
				background-color: #000000;
				margin: 0px;
				overflow: hidden;
				font-family:Monospace;
				font-size:13px;
				text-align:center;
				font-weight: bold;
				text-align:center;
			}
			a {
				color:#0078ff;
			}
			#info {
				color:#fff;
				position: absolute;
				top: 0px; width: 100%;
				padding: 5px;
				z-index:100;
			}
		</style>
	</head>
	<body>

		<div id="info">
			<a href="http://threejs.org" target="_blank">three.js</a> - webgl particle sprites example -
			snowflakes by <a href="http://en.wikipedia.org/wiki/File:Sketch_of_snow_crystal_by_Ren%C3%A9_Descartes.jpg">Ren&eacute;  Descartes</a>
		</div>

		<script src="js/three_v84.min.js"></script>

		<script src="js/Detector.js"></script>
		<script src="js/libs/stats.min.js"></script>

	<script id="vertexShader" type="x-shader/x-vertex">
		varying vec2 vUv;
		void main()
		{	vUv = uv;
			vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
			gl_Position = projectionMatrix * mvPosition;
		}
	</script>

	<script id="fragmentShader" type="x-shader/x-fragment">
		uniform sampler2D texture;
		uniform vec3 color;
		varying vec2 vUv;
		void main()
		{	vec3 tColor = texture2D( texture, vUv ).rgb;
			float a = (length(tColor - color) - 0.5) * 7.0;
		
			//		gl_FragColor = vec4(a, a, a, 1.0);
			gl_FragColor = vec4(tColor, a);
		}
	</script>

	<script>
		var videoTexture;
		function ChromaKeyMaterial(url, width, height, keyColor) 
		{	THREE.ShaderMaterial.call(this);
			video					= document.createElement('video');
			video.loop				= true;
			video.src				= url;
			video.load();
			video.play();

			var videoImage			= document.createElement('canvas');
			//if (window["webkitURL"]) document.body.appendChild(videoImage);
			if (window["URL"]) document.body.appendChild(videoImage);
			videoImage.width		= width;
			videoImage.height		= height;
	
			var keyColorObject		= new THREE.Color(keyColor);
			var videoImageContext	= videoImage.getContext('2d');
	
			// background color if no video present
			videoImageContext.fillStyle = '#' + keyColorObject.getHexString();
			videoImageContext.fillRect(0, 0, videoImage.width, videoImage.height);

			videoTexture		= new THREE.Texture(videoImage);
			//var videoTexture		= new THREE.Texture(videoImage);
			videoTexture.minFilter	= THREE.LinearFilter;
			videoTexture.magFilter	= THREE.LinearFilter;

			this.update = function () 
			{	if (video.readyState === video.HAVE_ENOUGH_DATA) 
				{	videoImageContext.drawImage(video, 0, 0);
					if (videoTexture)videoTexture.needsUpdate = true;
				}
			}

			this.setValues({	uniforms:		{	texture:	{type: "t",value: videoTexture},
													color:		{type: "c",value: keyColorObject}
												},
								vertexShader:	document.getElementById('vertexShader').textContent,
								fragmentShader: document.getElementById('fragmentShader').textContent,
								transparent:	true
			});
		}

		ChromaKeyMaterial.prototype = Object.create(THREE.ShaderMaterial.prototype);

		//////////////////////////////////////////////////////////////////////////////////
		class mySpriteMovie
		{	constructor(scene)
			{	///////////////////////////////////////////////////////////////////////////
				//var movieMaterial 	= new ChromaKeyMaterial('tree1.ogv', 242, 421, 0xd400);
				//var movieMaterial 	= new ChromaKeyMaterial('pocoyo_dance.mp4', 242, 421, 0xd400);
				this.movieMaterial		= new ChromaKeyMaterial('troll_dance3.webm', 320,240, 0xd400);
				this.movieGeometry		= new THREE.PlaneGeometry(60, 105, 4, 4);

				this.girls = [];
				for (var i = 0; i < 50; i++)
				{	for (var j = 0; j < 50; j++)
					{	if ((i + j) % 2 == 0) 
						{	var movie = new THREE.Mesh(this.movieGeometry,this.movieMaterial);
							movie.position.set(0, 53, 0);
	
							var girl = new THREE.Object3D();
							//girl.position.set(150 * (i - 2), 0, 150 * (j - 2));
							girl.position.set(50 * (i - 2), 0, 50 * (j - 2));

							girl.add(movie);
							scene.add(girl);

							this.girls.push(girl);
						}
					}
				}
			}
			
			render()
			{	this.movieMaterial.update();
			}
			
		}
		//////////////////////////////////////////////////////////////////////////////////
		class mySpritePoint
		{	constructor(scene)
			{	this.materials = [];
				var textureLoader = new THREE.TextureLoader();
					
				this.sprite1 = textureLoader.load( "textures/sprites/snowflake1a.png" );//videoTexture;//
				this.sprite2 = textureLoader.load( "textures/sprites/snowflake2a.png" );//videoTexture;//
				this.sprite3 = textureLoader.load( "textures/sprites/snowflake3a.png" );//videoTexture;//
				this.sprite4 = textureLoader.load( "textures/sprites/snowflake4a.png" );//videoTexture;//
				this.sprite5 = textureLoader.load( "textures/sprites/snowflake5a.png" );//videoTexture;//

				this.parameters =[	[ [1.0,  0.2,  0.5], this.sprite2, 20 ],
									[ [0.95, 0.1,  0.5], this.sprite3, 15 ],
									[ [0.90, 0.05, 0.5], this.sprite1, 10 ],
									[ [0.85, 0,    0.5], this.sprite5, 8  ],
									[ [0.80, 0,    0.5], this.sprite4, 5  ]
								];

				/////////////////////////////////////////////////////////////////////
				
				var max_particles	= 10000;
				var n = 1000, n2 = n / 2; // particles spread in the cube_material

				//////////////////////////////////////////////////////////////////////
				this.geometry = new THREE.Geometry();
				for (var i = 0; i < max_particles; i ++ ) 
				{	var vertex = new THREE.Vector3();
					vertex.x = Math.random() * n - n2;//Math.random() * 2000 - 1000;
					vertex.y = Math.random() * n - n2;//Math.random() * 2000 - 1000;
					vertex.z = Math.random() * n - n2;//Math.random() * 2000 - 1000;
					this.geometry.vertices.push( vertex );
				}

				var color,sprite,size,particles;
				for (var i = 0; i < this.parameters.length; i ++ ) 
				{	color  = this.parameters[i][0];
					sprite = this.parameters[i][1];
					size   = this.parameters[i][2];
						
					//this.materials[i] = new THREE.PointsMaterial( { size: size, map: sprite} );
					//this.materials[i] = new THREE.PointsMaterial( { size: size, map: sprite, transparent : true } );
					//this.materials[i] = new THREE.PointsMaterial( { size: size, map: sprite, depthTest: false, transparent : true } );
					this.materials[i] = new THREE.PointsMaterial( { size: size, map: sprite, blending: THREE.AdditiveBlending, depthTest: false, transparent : true } );
					this.materials[i].color.setHSL( color[0], color[1], color[2] );
						
					particles = new THREE.Points( this.geometry, this.materials[i] );
					//particles = new THREE.Points( this.geometry, this.movieMaterial );
					
					particles.rotation.x = Math.random() * 6;
					particles.rotation.y = Math.random() * 6;
					particles.rotation.z = Math.random() * 6;
					scene.add( particles );
				}
			}
				
			render(time,scene)
			{	var object,length=scene.children.length;
				for (var i = 0; i < length; i ++ ) 
				{	object = scene.children[ i ];
					if ( object instanceof THREE.Points ) 
					{	object.rotation.y = time * ( i < 4 ? i + 1 : - ( i + 1 ) );
					}
				}
				
				var color;
				length=this.materials.length;
				for (var i = 0; i < length; i ++ ) 
				{	color = this.parameters[i][0];
					//h = ( 360 * ( color[0] + time ) % 360 ) / 360;
					//materials[i].color.setHSL( h, color[1], color[2] );
					this.materials[i].color.setHSL(( 360 * ( color[0] + time ) % 360 ) / 360, color[1], color[2] );
				}
			}
		}		
	</script>
////////////////////////////////////////////////////////////////////////////////////////

		<script>
			if ( ! Detector.webgl ) Detector.addGetWebGLMessage();
			var container, stats;
			//var camera, scene, renderer, particles, geometry, materials = [], parameters, i,h, color, sprite, size;
			var camera, scene, renderer;//, particles, geometry, materials = [], parameters, color, sprite, size;
			//var materials = [],parameters;
			
			var mouseX = 0, mouseY = 0;
			var windowHalfX = window.innerWidth / 2;
			var windowHalfY = window.innerHeight / 2;
			
			init();
			createFloor(scene);
			//createSpritePoint();
			var mysp	= new mySpritePoint(scene);
			var mymov	= new mySpriteMovie(scene);
			
			animate();
			
			function init() 
			{	container = document.createElement( 'div' );
				document.body.appendChild( container );
				
				camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 2000 );
				//camera.position.z = 1000;
				camera.position.set(0, 150, 900);
				
				scene = new THREE.Scene();
				scene.fog = new THREE.FogExp2( 0x000000, 0.0008 );
				
				renderer = new THREE.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );
				
				stats = new Stats();
				container.appendChild( stats.dom );
				
				/*
				document.addEventListener( 'mousemove', onDocumentMouseMove, false );
				document.addEventListener( 'touchstart', onDocumentTouchStart, false );
				document.addEventListener( 'touchmove', onDocumentTouchMove, false );
				
				window.addEventListener( 'resize', onWindowResize, false );
				*/
			}
			
			function createFloor(scene)
			{	var textureLoader = new THREE.TextureLoader();
				var floorTexture		= new textureLoader.load('dirt_COLOR.jpg');
				floorTexture.anisotropy = renderer.getMaxAnisotropy();
				floorTexture.wrapS		= floorTexture.wrapT = THREE.RepeatWrapping;
				floorTexture.repeat.set(10, 10);

				var floor				= new THREE.Mesh(new THREE.PlaneGeometry(10000, 10000, 10, 10), new THREE.MeshBasicMaterial({map: floorTexture}));
    			floor.rotation.x 		= -Math.PI * 0.5;
            
				scene.add(floor);	
			}
			
/*			
			function createSpritePoint()
			{	geometry = new THREE.Geometry();
				var textureLoader = new THREE.TextureLoader();
				sprite1 = textureLoader.load( "textures/sprites/snowflake1a.png" );
				sprite2 = textureLoader.load( "textures/sprites/snowflake2a.png" );
				sprite3 = textureLoader.load( "textures/sprites/snowflake3a.png" );
				sprite4 = textureLoader.load( "textures/sprites/snowflake4a.png" );
				sprite5 = textureLoader.load( "textures/sprites/snowflake5a.png" );
				
				for (var i = 0; i < 10000; i ++ ) 
				{	var vertex = new THREE.Vector3();
					vertex.x = Math.random() * 2000 - 1000;
					vertex.y = Math.random() * 2000 - 1000;
					vertex.z = Math.random() * 2000 - 1000;
					geometry.vertices.push( vertex );
				}
				
				parameters =[	[ [1.0,  0.2,  0.5], sprite2, 20 ],
								[ [0.95, 0.1,  0.5], sprite3, 15 ],
								[ [0.90, 0.05, 0.5], sprite1, 10 ],
								[ [0.85, 0,    0.5], sprite5, 8  ],
								[ [0.80, 0,    0.5], sprite4, 5  ]
							];
				
				var color;
				for (var i = 0; i < parameters.length; i ++ ) 
				{	color  = parameters[i][0];
					sprite = parameters[i][1];
					size   = parameters[i][2];
					materials[i] = new THREE.PointsMaterial( { size: size, map: sprite, blending: THREE.AdditiveBlending, depthTest: false, transparent : true } );
					materials[i].color.setHSL( color[0], color[1], color[2] );
					particles = new THREE.Points( geometry, materials[i] );
					particles.rotation.x = Math.random() * 6;
					particles.rotation.y = Math.random() * 6;
					particles.rotation.z = Math.random() * 6;
					scene.add( particles );
				}
			}
*/			

/////////////////////////////////////////////////////////////////////////////////////////////
			/*
			function onWindowResize() {
				windowHalfX = window.innerWidth / 2;
				windowHalfY = window.innerHeight / 2;
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );
			}
			function onDocumentMouseMove( event ) {
				mouseX = event.clientX - windowHalfX;
				mouseY = event.clientY - windowHalfY;
			}
			function onDocumentTouchStart( event ) {
				if ( event.touches.length === 1 ) {
					event.preventDefault();
					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					mouseY = event.touches[ 0 ].pageY - windowHalfY;
				}
			}
			function onDocumentTouchMove( event ) {
				if ( event.touches.length === 1 ) {
					event.preventDefault();
					mouseX = event.touches[ 0 ].pageX - windowHalfX;
					mouseY = event.touches[ 0 ].pageY - windowHalfY;
				}
			}
			*/
			
			function animate() 
			{	requestAnimationFrame( animate );
				render();
				stats.update();
			}
			
			function render() 
			{	var time = Date.now() * 0.00005;
			
				//camera.position.x += (  mouseX - camera.position.x ) * 0.05;
				//camera.position.y += ( -mouseY - camera.position.y ) * 0.05;
				camera.lookAt( scene.position );
				
				mysp.render(time,scene);
				mymov.render();
				
				renderer.render( scene, camera );
			}
		</script>
	</body>
</html>