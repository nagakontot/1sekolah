<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/>
		
		<!--link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"-->
 		<!--link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"-->
 		<!--link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/smoothness/jquery-ui.css"-->
 		<!--link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/hot-sneaks/jquery-ui.css"-->
 		<!--link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/trontastic/jquery-ui.css"-->
 		
 		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/themes/trontastic/jquery-ui.min.css"></link>
 		<link rel="stylesheet" href="stylesheets/main_chat.css"></link>

		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    	<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

 		<!--script src="/cdn-cgi/apps/head/Y8iEO58aMYTDhkPG-quHkQ8TqBA.js"></script-->
    	
    	<!------------------------------------------------------------------------------------------------------->
    	<!--script src="https://cdnjs.cloudflare.com/ajax/libs/string.js/3.3.3/string.min.js"></script-->
    	<!--script src="https://unpkg.com/striptags@3.1.1/src/striptags.js"></script-->
    	<!--script src="https://unpkg.com/string-strip-html@1.3.2/dist/string-strip-html.umd.js"></script-->
    	<!------------------------------------------------------------------------------------------------------->
    	
    	<script src="https://www.1sekolah.xyz/js/lib/myutils.js"></script>
    	<script src="https://www.1sekolah.xyz/js/lib/rpc/iframeRPC.js"></script>

    	<!--script src="https://browserify.1sekolah.xyz/bundle/:underscore"></script-->
    	<!--script src="https://browserify.1sekolah.xyz/standalone/underscore@latest"></script-->
    	<!--script src="https://wzrd.in/standalone/underscore@latest"></script-->
    	<!--script src="https://cdn.jsdelivr.net/npm/underscore@1.8.3/underscore.min.js"></script-->
    	

    	<!--script src="https://browserify.1sekolah.xyz/modules/browserify-client"></script-->
    	<!--script src="https://browserify.1sekolah.xyz/modules/qs"></script-->
    	
		<!--script src="https://cdn.tinymce.com/4/tinymce.min.js"></script-->
  		<!--script>tinymce.init({ selector:'textarea' });</script-->
  		
  		<script>
			$(document).ready(function()
    		{	$("#tabs0, #tabs-top0, #tabs-top1, #tabs-top2, #tabs-top3, #tabs-top4, #tabs-top5, #tabs-top6, #tabs-top7, #tabs-top8, #tabs-top9, #tabs-top10").tabs
    			({	beforeActivate: 	function (event, ui) 
            							{	//console.log(ui.newPanel.attr('id'));
            							}
        		});
			});
  		</script>
  
		<script>


			//var us = require('underscore');
			
			//var client = require('browserify-client').connect('https://browserify.1sekolah.xyz');
			//var qs = require('qs');
			//var client = require('browserify-client');//.connect('http://localhost:4000');
			//client.require('underscore', function(err, _) 
			//{	// _ is set to the latest version of underscore
 			//});
 			
			//////////////////////////////////////////////////////
			//window.location.href = 'https://www.1sekolah.xyz/main.html';
			//var messagesPanel, first = true, ws, id;
			//var messagesPanel, 
			
			var ws, id;
			var first				= [];
			var typedMessage		= [];
			var messages			= [];
			var timeout             = null;

			window.ChatSubjects     = ["LOBI","MATH","SAINS","BIOLOGI","KIMIA","FIZI","BM","BI","ADDMATH","NETWORK","HELP"];
			window.ChatCurrentIndex = 0;
			window.ChatRows 		= 9;
			window.ChatCols 		= 20;//4;
			
			const mysession	= new CSession();
			//mysession.set("username",mysession.get("username"));
			//id = mysession.get("username");
						
			function main() 
			{	///////////////////////////////////////
				//var vonkeydown_ = function onkeydown_(e,typedMessage)
				//function onkeydown_(e,typedMessage)
				function onkeydown_(e,index)
				{	window.ChatCurrentIndex = index;
					if (e.keyCode === 13 && !e.shiftKey) 
					{	if (typedMessage[index].value.length) 
						{	clearTimeout(timeout);
							timeout = setTimeout(function () 
							{	//this is a good point for command-line help!
								//if (typedMessage[index].value === "can i has new color?") 
								//{	id = Math.floor(Math.random() * 1000000);
								//	localStorage.id = id;
								//}
						
								///////////////////////////////////////////////////////////////////////////////
								//strip all html tags
								typedMessage[index].value = (typedMessage[index].value).replace(/(<([^>]+)>)/ig,"");
								//typedMessage[index].value = String(index)+"@&%"+window.ChatSubjects[getY_from_Index(index,window.ChatCols)]+"@&%"+ mysession.get("userimg")+"@&%"+mysession.get("username")+"@&%"+typedMessage[index].value;

								//alert("getY_from_Index("+index+","+window.ChatCols+") = "+Math.floor(getY_from_Index(index,window.ChatCols)));
								//typedMessage[index].value = String(index)+"@&%"+window.ChatSubjects[Math.floor(getY_from_Index(index,window.ChatCols))]+" [Bab"+(getX_from_Index(index,window.ChatCols)+1)+"] "+"@&%"+ mysession.get("userimg")+"@&%"+mysession.get("username")+"@&%"+typedMessage[index].value;
								typedMessage[index].value = String(index)+"@&%"+window.ChatSubjects[Math.trunc(getY_from_Index(index,window.ChatCols))]+" [Bab"+(getX_from_Index(index,window.ChatCols)+1)+"] @&%"+ mysession.get("userimg")+"@&%"+mysession.get("username")+"@&%"+typedMessage[index].value;

								///////////////////////////////////////////////////////////////////////////////
								typedMessage[index].value = typedMessage[index].value.substring(0, 512);
								addMessage(id, typedMessage[index].value, false);
								ws.send(id + " " + typedMessage[index].value);
								typedMessage[index].value = "";
							}, 250);
						}
						else 
						{	typedMessage[index].value = "";
						}
						return false;
					}
					return true;
				}

				//var vonclick_ = function onclick_(typedMessage,first)
				//function onclick_(typedMessage,first)
				function onclick_(index)
				{	window.ChatCurrentIndex = index;
					//alert("window.ChatCurrentIndex="+window.ChatCurrentIndex);
					if (first[index])
					{	typedMessage[index].value = "";
						first[index] = false;
					}
				}
				
				////////////////////////////////////////////////////////////////////////////////
				////////////////////////////////////////////////////////////////////////////////
				//messagesPanel	= document.getElementById("messagesPanel");
			
				//var rows=9,cols=4;
				var rows = window.ChatRows;
				var cols = window.ChatCols;

				var i,j,typedid,typedid2;//,tm,fst;
				for(i=0;i<rows;i++)
				{	typedid 								= "typedMessage"+String(i)+"-";
					
					for(j=0;j<cols;j++)
					{	typedid2 							= typedid+String(j);

						index=getIndex(i,j,cols);
						//console.log("typedid2="+typedid2+", index="+index);

						typedMessage[index]					= getArray(typedMessage,index);
						first[index]						= getArray(first,index);
						
						typedMessage[index]					= document.getElementById(typedid2);
						first[index]						= true;
						
						typedMessage[index].myParam 		= index;
						typedMessage[index].onkeydown		= (e)=>{ return onkeydown_(e,e.currentTarget.myParam);}
						typedMessage[index].onclick 		= (e)=>{ onclick_(e.currentTarget.myParam);}
					}
				}
			
				//const mysession	= new CSession();
				//mysession.set("username",mysession.get("username"));
				//id = mysession.get("username");
				if (localStorage.id) 
				{	id = localStorage.id;
				} 
				else 
				{	id = Math.floor(Math.random() * 1000000);
					localStorage.id = id;
				}
	
				//ws = new WebSocket("ws://" + window.location.hostname + ":" + window.location.port);
				ws = new WebSocket("wss://socket.1sekolah.xyz");
				
				ws.onmessage = function(e) 
				{	if (e.data.charAt(0) == 'S') 
					{	var info = e.data.split(" ");
						statusBar.textContent = 'General demo chat built with ÂµWebSockets. ' + info[1] + ' user(s) online, ' + info[2] + ' kb of user space memory.';
						for(i=0;i<rows;i++)
						{	for(j=0;j<cols;j++)
							{	typedMessage[getIndex(i,j,cols)].disabled = false;
							}
						}
					} 
					else 
					{	var splitPos = e.data.indexOf(" ");
						if (splitPos != -1) 
						{	var incomingId = e.data.substr(0, splitPos);

							if (typedMessage[window.ChatCurrentIndex].disabled || incomingId != id)
							{	addMessage(incomingId, e.data.substr(splitPos), incomingId != id);
							}
						}
					}
				};
	
				ws.onclose = function() 
				{	statusBar.textContent = 'Connection lost';
					for(i=0;i<rows;i++)
					{	for(j=0;j<cols;j++)
						{	typedMessage[getIndex(i,j,cols)].disabled = true;
						}
					}
				};
			}

			function addMessage(id, message, left) 
			{	//client('talk',message,function(err,price){alert('price:' + price);});
			    //message = mysession.get("username") + ": " + message;
			    //message = mysession.get("userimg")+"@&%"+mysession.get("username")+"@&%"+message;
				//client('talk',message,function(err,price){});
				
				const [cindex,csubj,cimg,cuser,cmsg] = message.split('@&%');

				//only print msg when it is from the same subject				
				var dunnowhythereisawhitespaceinfrontofcindex = " "+String(window.ChatCurrentIndex);
				if(cindex===dunnowhythereisawhitespaceinfrontofcindex || cindex===String(window.ChatCurrentIndex))
				{	client('talk',message,function(err,price){});
				}

				/*
				var flexBox = document.createElement('div');
				flexBox.style = 'display: flex; ' + (left ? '' : 'justify-content: flex-end');
				var messageBox = document.createElement('p');
				//messageBox.style = "background-color: hsl(" + (id / 16 * 360) + ", 100%, 50%); overflow: hidden; text-overflow: ellipsis;";
				messageBox.style = "background-color: hsl(" + (id / 8 * 360) + ", 100%, 50%); overflow: hidden; text-overflow: ellipsis;";
				messageBox.textContent = message;
				flexBox.appendChild(messageBox);
				
				if (messages.length == 50) 
				{	messagesPanel.removeChild(messages.shift());
				}
				
				messages.push(flexBox);
				setTimeout(function() 
				{	messageBox.className = "show";
				}, 10);
	
				var wereBottomScrolled = true;//messagesPanel.scrollTop == messagesPanel.scrollHeight;
				messagesPanel.appendChild(flexBox);
				if (wereBottomScrolled) 
				{	messagesPanel.scrollTop = messagesPanel.scrollHeight;
				}
				*/
			}
			
			/////////////////////////////////////////////////////////
			var client = iframeRPC.createClient('https://www.1sekolah.xyz');
			//client('getPrice', 1234, function (err, price) 
			//{	alert('price:' + price);
			//});
			/////////////////////////////////////////////////////////
			//client('sum', [1,2,3,4], function (err, total) 
			//{	alert('total:' + total);
			//});			
			/////////////////////////////////////////////////////////
		</script>
	</head>
	
	<!--body onload="main();window.location.assign('https://www.1sekolah.xyz/main.html');"-->
	<body onload="main()">

		<!--section id="messagesPanel"></section-->

		<!-------------------------------------------------------------->
		<div id="tabs0">
	  		<!------------------------------------------------------------------>	
  			<script>
  				//var TopicString = ["",];
				//var s = function(){/*
				//					STRING
				//					GOES
				//					HERE
				//				   */}.multiline();
    			//console.log("s="+s);
				//window.ChatSubjects= ["LOBI","MATH","SAINS","BIOLOGI","KIMIA","FIZI","BM","BI","ADDMATH","NETWORK","HELP"];
				/*
				var chatHTML=
				`<ul>
	    			<li><a href="#tabs-top0">LOBI</a></li>
    				<li><a href="#tabs-top1">MATH</a></li>
    				<li><a href="#tabs-top2">SAINS</a></li>
    				<li><a href="#tabs-top3">BIOLOGI</a></li>
    				<li><a href="#tabs-top4">KIMIA</a></li>
    				<li><a href="#tabs-top5">FIZIK</a></li>
    				<li><a href="#tabs-top6">BM</a></li>
    				<li><a href="#tabs-top7">BI</a></li>
    				<li><a href="#tabs-top8">ADDMATH</a></li>
    				<li><a href="#tabs-top9">NETWORK</a></li>
    				<li><a href="#tabs-top10">HELP</a></li>
  				</ul>`;
  				*/
  				var tab="";
  				var chatHTML="<ul>";
				for(i=0;i<window.ChatRows;i++)
				{	tab = "#tabs-top" + String(i);
					chatHTML+= '<li><a href="'+tab+'">'+window.ChatSubjects[i]+'</a></li>';
				}
    			chatHTML +=	'<li><a href="#tabs-top9">NETWORK</a></li><li><a href="#tabs-top10">HELP</a></li>';
				chatHTML += "</ul>";

				for(i=0;i<window.ChatRows;i++)
				{	chatHTML += '<div id="tabs-top'+String(i)+'">';
						chatHTML += '<ul>';
						for(j=0;j<window.ChatCols;j++)
						{	chatHTML += '<li><a href="#tabs-top'+String(i)+'-'+String(j)+'">bab'+String(j+1)+'</a></li>';
						}
						chatHTML += '</ul>';
						for(j=0;j<window.ChatCols;j++)
						{	chatHTML += '<div id="tabs-top'+String(i)+'-'+String(j)+'"><textarea id="typedMessage'+String(i)+'-'+String(j)+'" disabled>Type your message here...</textarea></div>';
						}
					chatHTML += '</div>';
				}						
				$('#tabs0').html(chatHTML);
  			</script>
					
	  		<!------------------------------------------------------------------>	
  			<div id="tabs-top9"><div id="statusBar">Connecting...</div></div>
  			
	  		<!------------------------------------------------------------------>	
  			<div id="tabs-top10">
  				<div id="helpBar">
    				<!--Send Message: <button id="message_button">Hi parent</button>-->
    				Send Message: <button onclick="client('getPrice',1234,function(err,price){alert('price:' + price);});">Hi parent</button>

    				<script>
    					/*
    					var message_button = document.getElementById('message_button');
						message_button.onclick = function()
						{	if (typeof callParent === 'function') 
							{	callParent();
							}
    						else 
    						{	var script	= document.createElement("script");
    							script.type = "text/javascript";
    							script.src	= "js/test1.js"; 
    							document.getElementsByTagName("head")[0].appendChild(script);
								
								//setTimeout(callParent, 1000);
    						}
    						return false;
						}
						*/
    					///////////////////////////////////////////////////
    					/*
    					//var isSent = false;
        				// Send random message data on every button click
        				bindEvent(document.getElementById('message_button'), 'click', function (e) 
        				{	//client('getPrice', 1234, function (err, price) 
							//{	alert('price:' + price);
							//	//sendMessage('price:' + String(price));
							//});
							
        					
        					isSent = !isSent;
                       		if(isSent)
            				{	client('getPrice', 1234, function (err, price) 
								{	//alert('price:' + price);
									//sendMessage('price:' + String(price));
								});
            				}	
							/////////////////////////////////////////////////////////
							else
							{	client('sum', [1,2,3,4], function (err, total) 
								{	//alert('total:' + total);
									//sendMessage('sum total:' + String(total));
								});
							}
							
        				});
        				*/
    				</script>
  				</div>
  			</div>
		</div>		
		
	</body>
</html>